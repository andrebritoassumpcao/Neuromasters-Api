-- 1) TABELA DE GRUPOS DE HABILIDADES
CREATE TABLE NEURO_GRP_HAB (
  NEURO_COD_GRP VARCHAR(6)  NOT NULL,
  NEURO_DES_GRP VARCHAR(60) NOT NULL,
  CONSTRAINT PK_NEURO_GRP_HAB PRIMARY KEY (NEURO_COD_GRP)
);

-- 2) TABELA DE COMPETÊNCIAS DE HABILIDADES
CREATE TABLE NEURO_COM_HAB (
  NEURO_COD_GRP  VARCHAR(6)  NOT NULL,  
  NEURO_COD_COMP INTEGER     NOT NULL,  
  NEURO_DES_COMP VARCHAR(60) NOT NULL,
  NEURO_SEQ_COMP INTEGER     NOT NULL,
  CONSTRAINT PK_NEURO_COM_HAB PRIMARY KEY (NEURO_COD_COMP),
  CONSTRAINT FK_NEURO_COM_HAB_GRP
    FOREIGN KEY (NEURO_COD_GRP)
    REFERENCES NEURO_GRP_HAB (NEURO_COD_GRP)
    ON UPDATE CASCADE
    ON DELETE RESTRICT,

  CONSTRAINT UQ_NEURO_COM_HAB_GRP_SEQ UNIQUE (NEURO_COD_GRP, NEURO_SEQ_COMP)
);

-- 3) TABELA DE GRAU DE COMPETÊNCIA
CREATE TABLE NEURO_GRA_COM (
  NEURO_COD_GRP  VARCHAR(6)  NOT NULL,  
  NEURO_COD_GRA INTEGER     NOT NULL,
  NEURO_DES_GRA VARCHAR(20) NOT NULL,
  CONSTRAINT PK_NEURO_GRA_COM PRIMARY KEY (NEURO_COD_GRA)
);

-- QUESTIONÁRIOS
CREATE TABLE NEURO_FORM (
  FORM_ID      INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  FORM_NAME    VARCHAR(120) NOT NULL,
  FORM_DESC    VARCHAR(255),
  FORM_STATUS  VARCHAR(20) NOT NULL DEFAULT 'draft',
  CREATED_AT   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UPDATED_AT   TIMESTAMPTZ
);

-- SEÇÕES
CREATE TABLE NEURO_FORM_SECTION (
  SECTION_ID   INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  FORM_ID      INT NOT NULL,
  SEC_NAME     VARCHAR(120) NOT NULL,
  NEURO_COD_GRP VARCHAR(6),
  SEQ_ORDER    INT NOT NULL,
  CONSTRAINT FK_FORM_SECTION_FORM FOREIGN KEY (FORM_ID) REFERENCES NEURO_FORM(FORM_ID) ON DELETE CASCADE,
  CONSTRAINT FK_FORM_SECTION_GRP FOREIGN KEY (NEURO_COD_GRP) REFERENCES NEURO_GRP_HAB(NEURO_COD_GRP) ON DELETE SET NULL
);

-- PERGUNTAS
CREATE TABLE NEURO_FORM_QUESTION (
  QUESTION_ID   INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  SECTION_ID    INT NOT NULL,
  QUESTION_TEXT VARCHAR(255) NOT NULL,
  NEURO_COD_COMP INT,
  OBSERVATIONS  VARCHAR(255),
  SEQ_ORDER     INT NOT NULL,
  CONSTRAINT FK_SECTION_QUESTION FOREIGN KEY (SECTION_ID) REFERENCES NEURO_FORM_SECTION(SECTION_ID) ON DELETE CASCADE,
  CONSTRAINT FK_FORM_QUESTION_COMP FOREIGN KEY (NEURO_COD_COMP) REFERENCES NEURO_COM_HAB(NEURO_COD_COMP) ON DELETE SET NULL
);

-- RESPOSTAS
CREATE TABLE NEURO_FORM_RESPONSE (
  RESPONSE_ID   INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  FORM_ID       INT NOT NULL,
  USER_ID       VARCHAR(50) NOT NULL,
  QUESTION_ID   INT NOT NULL,
  DEGREE_CODE   INT NOT NULL,
  OBSERVACAO    VARCHAR(255),
  CREATED_AT    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT FK_FORM_RESPONSE_FORM 
    FOREIGN KEY (FORM_ID) REFERENCES NEURO_FORM(FORM_ID) ON DELETE CASCADE,
  CONSTRAINT FK_QUESTION_RESPONSE 
    FOREIGN KEY (QUESTION_ID) REFERENCES NEURO_FORM_QUESTION(QUESTION_ID) ON DELETE CASCADE,
  CONSTRAINT FK_RESPONSE_DEGREE 
    FOREIGN KEY (DEGREE_CODE) REFERENCES NEURO_GRA_COM(NEURO_COD_GRA) ON DELETE RESTRICT
);